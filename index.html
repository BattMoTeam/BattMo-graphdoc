<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Computation Graph Model Design ang Assembly &mdash; BattMo  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="_static/sphinx_collapse.css" />
      <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/custom.css" />

  
    <link rel="shortcut icon" href="_static/battmologo.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script src="_static/design-tabs.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="#" class="icon icon-home">
            BattMo
              <img src="_static/battmologo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Computation Graph Model Design ang Assembly</a><ul>
<li><a class="reference internal" href="#a-simple-introduction-example">A simple introduction example</a></li>
<li><a class="reference internal" href="#graph-composition">Graph composition</a></li>
</ul>
</li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">BattMo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="#" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Computation Graph Model Design ang Assembly</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/graphdoc.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="computation-graph-model-design-ang-assembly">
<h1>Computation Graph Model Design ang Assembly<a class="headerlink" href="#computation-graph-model-design-ang-assembly" title="Permalink to this heading"></a></h1>
<p>A model is a computational graph. We have identified variables. Variables are dependent one from the other. The
dependence can be explicit or implicit. In the explicit case, a variable can be directly computed from the
other using a function evaluation. In the implicit case, such function does not exist in a simple form. The
relationship between the variables is given through equations. The purpose of our simulations is to solve these
equations. The equations are added to the system of non-linear equation we solve, at each time step in the case
of an evolution problem.</p>
<p>In the computational graph, the nodes are given by the variables in the model. The directed edges represent the
functional dependency between the variables</p>
<section id="a-simple-introduction-example">
<h2>A simple introduction example<a class="headerlink" href="#a-simple-introduction-example" title="Permalink to this heading"></a></h2>
<p>Let us consider the example of a reaction model. The reaction rate <span class="math notranslate nohighlight">\(R\)</span> is given
by</p>
<div class="math notranslate nohighlight">
\begin{align*}
R &amp;= j\left(e^{-\alpha\frac{\eta}{RT}} + e^{(1-\alpha)\frac{\eta}{RT}}\right)\\
j&amp;= k c_s(1 - c_e)^{\frac12}c_e^\frac12\\
\eta &amp;= \phi_s - \phi_e - \text{OCP}\\
\text{OCP} &amp;= \hat{\text{OCP}}(c_s)
\end{align*}</div><p>We have seven variables <span class="math notranslate nohighlight">\(R,\ j, \eta, \text{OCP}, \phi_s, \phi_e, c_s, c_e\)</span>. The dependency graph we
obtain from the equations above is</p>
<img alt="_images/reacmodelgraph.png" src="_images/reacmodelgraph.png" />
<p>This graph has been obtained in BattMo after we implemented the model. We will explain later how this can be
done (for the impatient, see here)</p>
<p>The graph is a <a class="reference external" href="https://en.wikipedia.org/wiki/Directed_acyclic_graph">directed acyclic graph</a>, meaning that
it has no loop. We can thus identify <em>root</em> and <em>tail</em> variables. In the case above, the root variables are
<span class="math notranslate nohighlight">\(\phi_s, \phi_e, c_s, c_e\)</span> and there only one tail variable, <span class="math notranslate nohighlight">\(R\)</span>. Given values for the root
variables, we can traverse the graph and evaluate all the intermediate variables to compute the tail
variables. To evaluate variables, the functions we will implement will always need parameters (the opposite
case where a function can be defined without any external parameters is expected to be rare in a physical
context). Then, we can describe our model with</p>
<ul class="simple">
<li><p>A set of parameters (scalar variables, but maybe also functions)</p></li>
<li><p>A computational graph</p></li>
<li><p>A set of functions associated to each node (i.e. variable) which as an incoming edge in the computational
graph</p></li>
</ul>
<p>For each of the function in the set above, we know the input and output arguments. They are given by the nodes
connected by the edge.</p>
<p>The motivation for introducing suuch graph representation is <strong>expressivity</strong>. It provides a synthetic overview
of the model. Of course, the precise expression of the functions, which is not visible in the graph, is an
essential part. All the physics is encoded there. But, the graph gives us access to the dependency between the
variables and the variables have been chosen by the user in the model because of their specific physical
meaning. The user has chosen them from a physical insight, that we want to preserve. Especially when we expand
the models. In our previous examples, the variables we have introduced have all a name meaningfull for the
expert in the domains.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 27%" />
<col style="width: 73%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>R</p></td>
<td><p>Reaction Rate</p></td>
</tr>
<tr class="row-even"><td><p>j</p></td>
<td><p>Exchange Current Density</p></td>
</tr>
<tr class="row-odd"><td><p>eta</p></td>
<td><p>Over-potential</p></td>
</tr>
<tr class="row-even"><td><p>OCP</p></td>
<td><p>Open Circuit Potential</p></td>
</tr>
<tr class="row-odd"><td><p>phi_s, phi_e</p></td>
<td><p>Solid and Electrolyte potentials</p></td>
</tr>
<tr class="row-even"><td><p>c_s, c_e</p></td>
<td><p>Solid and Electrolyte concentrations</p></td>
</tr>
</tbody>
</table>
<p>A user can inspect a given model first by looking at the graph, recognized the variables that are named
here. They should be meaningfull to him, as they should have been chosen to correspond to a given domain
expertise terminology (here electrochemistry).</p>
<p>Let us now see how we can compose computational graph</p>
</section>
<section id="graph-composition">
<h2>Graph composition<a class="headerlink" href="#graph-composition" title="Permalink to this heading"></a></h2>
<p>This model representation as a graph brings also <strong>flexibility</strong> in model building and in particular <strong>code
reusability</strong>. A user who wants to modify an existing model will typically be interested in keeping most of the
existing models, and reuse the variable update functions that are been defined there. Looking at the graph, we
can understand the dependency easily and identify the part that should be changed in the model. In some cases,
the dependency graph may not changed, only a different function should be called to update a variable. For
example, the exchange current density function <span class="math notranslate nohighlight">\(j\)</span> rarely obeys the ideal case presented above but is a
given tabulated function,</p>
<div class="math notranslate nohighlight">
\[j(c_e, c_s) = \hat{j}(c_s, c_s)\]</div>
<p>where <span class="math notranslate nohighlight">\(\hat{j}\)</span> is a given function the user has set up. Such function is an example of a functional
parameter belonging to the model, which we mentioned earlier.</p>
<p>Continuing with the same example, we may introduce a temperature dependency in the OCP function. We have</p>
<div class="math notranslate nohighlight">
\[\text{OCP} = \hat{\text{OCP}}(c_s, T)\]</div>
<p>Then, we have to introduce a new node (i.e. variable) in our graph, the temperature <code class="code docutils literal notranslate"><span class="pre">T</span></code>.</p>
<img alt="_images/reacmodelgraph2.png" src="_images/reacmodelgraph2.png" />
<p>Let us introduce an other model, at least its computational graph. We consider a simple heat equation</p>
<div class="math notranslate nohighlight">
\[\alpha T_t = \nabla\cdot(\lambda \nabla T) + q\]</div>
<p>We introduce in addition to the temperature <code class="code docutils literal notranslate"><span class="pre">T</span></code> the following variable names (nodes) and, in the right
column, we write the definition they will take after discretization. The operators <code class="code docutils literal notranslate"><span class="pre">div</span></code> and
<code class="code docutils literal notranslate"><span class="pre">grad</span></code> denotes the discrete differential operators used in the assembly.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 85%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>accumTerm</p></td>
<td><p><span class="math notranslate nohighlight">\(\alpha\frac{T - T^0}{\Delta t}\)</span></p></td>
</tr>
<tr class="row-even"><td><p>flux</p></td>
<td><p><span class="math notranslate nohighlight">\(-\lambda\text{grad}(T)\)</span></p></td>
</tr>
<tr class="row-odd"><td><p>sourceTerm</p></td>
<td><p><span class="math notranslate nohighlight">\(q\)</span></p></td>
</tr>
<tr class="row-even"><td><p>energyCons</p></td>
<td><p><span class="math notranslate nohighlight">\(\text{accumTerm} + \text{div}(\text{flux}) + \text{source}\)</span></p></td>
</tr>
</tbody>
</table>
<p>The computational for the temperature model is given by</p>
<img alt="_images/tempgraph.png" src="_images/tempgraph.png" />
<p>Having now two models, we can illustrate how we can combine the corresponding computational graph to obtain a
coupled model. Let us couple the two models in two ways. We include a heat source produced by the chemical
reaction, as some function of the reaction rate. The effect of the temperature on the chemical reaction is
included, as we presented earlier, as a additional temperature dependence of the open circuit potential
<code class="code docutils literal notranslate"><span class="pre">OCP</span></code>. We obtain the following computational graph</p>
<img alt="_images/tempreacgraph.png" src="_images/tempreacgraph.png" />
<p>In the node names, we recognize the origin of variable through a model name, either <code class="code docutils literal notranslate"><span class="pre">Reaction</span></code> or
<code class="code docutils literal notranslate"><span class="pre">Thermal</span></code>. We will come back later to that.</p>
<p>With this model, we can setup our first simulation. Given the concentrations and potentials, we want to obtain
the temperature, which can only obtained implicitely by solving the energy equation. Looking at the graph, we
find that the root variables are <code class="code docutils literal notranslate"><span class="pre">Thermal.T</span></code>, <code class="code docutils literal notranslate"><span class="pre">Reaction.c_s</span></code>, <code class="code docutils literal notranslate"><span class="pre">Reaction.phi_s</span></code>,
<code class="code docutils literal notranslate"><span class="pre">Reaction.c_e</span></code>, <code class="code docutils literal notranslate"><span class="pre">Reaction.phi_e</span></code>. The tail variable is the energy conservation equation
<code class="code docutils literal notranslate"><span class="pre">energyCons</span></code>. A priori, the system looks well-posed with same number of unknown and equation (one of
each). At this stage, we want our implementation to automatically detects the primary variables (the root node,
<code class="code docutils literal notranslate"><span class="pre">T</span></code>) and the equations (the tail node, <code class="code docutils literal notranslate"><span class="pre">energyCons</span></code>) and to proceed with the assembly by traversing
the graph. We will later how it is done.</p>
<p>To conclude this example, we introduce a model for the concentrations and make them time dependent. In the
earlier model, the concentrations were kept constant because, for example, access to an infinite reservoir of
the chemical species. Now, we consider the case of a closed reservoir and the composition evolve accordingly to
the chemical reaction. We have equations of the form</p>
<div class="math notranslate nohighlight">
\[\begin{align*}
\frac{dc_s}{dt} &amp;= R_s, &amp; \frac{dc_r}{dt} &amp;= R_e
\end{align*}\]</div>
<p>where the right-hand side is obtained from the computed reaction rate, following the stoichiometry of the
chemical reactions.</p>
<p>The computational grap for each of this equation take the generic form</p>
<img alt="_images/concgraph.png" src="_images/concgraph.png" />
<p>where</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 24%" />
<col style="width: 76%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>masssAccum</p></td>
<td><p><span class="math notranslate nohighlight">\(\frac{c - c^0}{\Delta t}\)</span></p></td>
</tr>
<tr class="row-even"><td><p>source</p></td>
<td><p><span class="math notranslate nohighlight">\(R\)</span></p></td>
</tr>
<tr class="row-odd"><td><p>massCons</p></td>
<td><p><span class="math notranslate nohighlight">\(\frac{c - c^0}{\Delta t} - R\)</span></p></td>
</tr>
</tbody>
</table>
<p>Let us now combine this model with the first one, which provided us with te computation of the chemical
reaction rate. We need two instance of the concentration model. To solve, the issue of <strong>duplicated</strong> variable
name, we add indices in our notations but this cannot be robustly scaled to large model. Instead, we introduce
model names and a model hierarchy. This was done already earlier with the <code class="code docutils literal notranslate"><span class="pre">Thermal</span></code> and <code class="code docutils literal notranslate"><span class="pre">Reaction</span></code>
models. Let us name our two concentration models as <code class="code docutils literal notranslate"><span class="pre">Solid</span></code> and <code class="code docutils literal notranslate"><span class="pre">Elyte</span></code>. We obtain the following
graph.</p>
<img alt="_images/concreacgraph.png" src="_images/concreacgraph.png" />
<p>We note that it becomes already difficult to read off the graph and it will become harder and harder as model
grow. We have developped visualization tool that will help us in exploring the model through their graphs.</p>
<p>Given <code class="code docutils literal notranslate"><span class="pre">phi_s</span></code> and <code class="code docutils literal notranslate"><span class="pre">phi_e</span></code>, we can solve the problem of computing the evolution of the
concentrations. The <em>root</em> nodes are the two concentrations (the potentials are known) and the <em>tail</em> nodes are
the mass conservation equations.</p>
<p>Finally, we can couple the model above with with the temperature, by <em>sewing</em> together the graphs. We name the
previous composite model as <code class="code docutils literal notranslate"><span class="pre">Masses</span></code> and keep the name of <code class="code docutils literal notranslate"><span class="pre">Thermal</span></code> for the thermal model. We
obtain the following</p>
<img alt="_images/tempconcreacgraph.png" src="_images/tempconcreacgraph.png" />
<p>New computational graphs are thus obtained by connecting existing graph, using a hierarchy of model. In the
example above, the model hierarchy is given by</p>
<img alt="_images/tempconcreacgraphmodel.png" src="_images/tempconcreacgraphmodel.png" />
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2023.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>